version: "3"
services:
  vantagecam:
    image: ghcr.io/mcgeaverbeaver/vantagecamlive:latest
    container_name: vantagecam

    # --- DEVICE MAPPING ---
    # Only needed if HARDWARE_ACCEL=true (default)
    # Comment out this section for software-only encoding
    devices:
      - /dev/dri:/dev/dri

    environment:
      # --- USER PERMISSIONS ---
      # Set these to match your host user/group for proper file ownership
      # Unraid: PUID=99, PGID=100 (nobody:users)
      # Most Linux: PUID=1000, PGID=1000
      - PUID=99
      - PGID=100

      # --- REQUIRED SETTINGS ---
      - RTSP_SOURCE=rtsp://user:pass@192.168.1.50:554/stream
      - ADMIN_USER=admin
      - ADMIN_PASS=change_me_please

      # --- HARDWARE ACCELERATION ---
      # Set to 'false' to use software encoding (no Intel GPU required)
      - HARDWARE_ACCEL=true
      # - VAAPI_DEVICE=/dev/dri/renderD128  # Override if needed

      # --- SOFTWARE ENCODING SETTINGS ---
      # Only used when HARDWARE_ACCEL=false
      # - SOFTWARE_PRESET=faster  # ultrafast|superfast|veryfast|faster|fast|medium
      # - SOFTWARE_CRF=23         # Quality (lower = better, 18-28 typical)

      # --- LOCAL STREAM SETTINGS ---
      - ENABLE_LOCAL_STREAM=false

      # --- WEATHER SETTINGS ---
      - WEATHER_LAT=40.7128
      - WEATHER_LON=-74.0060
      - WEATHER_LOCATION=My City
      - WEATHER_TIMEZONE=America/New_York
      - CAMERA_HEADING=E

      # --- ALERT REFRESH RATE ---
      # How often to check Env-Canada & OpenMeteo for new data (in seconds).
      # Default: 900 (15 Minutes)
      - ALERTS_UPDATE_INTERVAL=900

      # --- DEBUGGING ---
      # - WEATHER_DEBUG=true
      # - FFMPEG_PROGRESS_LOG=true  # Enable frame logging (WARNING: ~10MB/day)
      
      # --- FALLBACK MODE ---
      - FALLBACK_ENABLED=true  # Show "We'll Be Right Back" when camera is unreachable

      # --- VIDEO OUTPUT SETTINGS ---
      # - VIDEO_BITRATE=14M
      # - VIDEO_FPS=30
      # - SCALING_MODE=fill  # 'fill' or 'fit'

      # --- AD ROTATION SETTINGS ---
      # - SCALE_TL=500            # Top-left ad size
      # - SCALE_TR=400            # Top-right ad size
      # - OVERLAYAD_ROTATE_TIMER=30   # TL rotation seconds
      # - TR_SHOW_SECONDS=20      # TR display time
      # - TR_HIDE_SECONDS=300     # TR hide time
      # - DAY_START_HOUR=6        # When DAY mode starts
      # - DAY_END_HOUR=20         # When NIGHT mode starts

      # --- YOUTUBE SETTINGS ---
      - YOUTUBE_URL=rtmp://a.rtmp.youtube.com/live2
      - YOUTUBE_KEY=xxxx-xxxx-xxxx-xxxx
      # - YOUTUBE_BITRATE=4500k
      # - YOUTUBE_WIDTH=2560
      # - YOUTUBE_HEIGHT=1440

      # =======================================================================
      # SELF-HEALING WATCHDOG SETTINGS
      # =======================================================================
      # Enable/disable the self-healing watchdog
      - WATCHDOG_ENABLED=true

      # URL to your youtube_status.php endpoint
      # The watchdog will poll this to check if the stream is live
      - WATCHDOG_STATUS_URL=https://yourdomain.com/youtube_status.php

      # Seconds to wait after boot before first status check
      # YouTube needs time to recognize the ingest (default: 180 = 3 minutes)
      - WATCHDOG_STARTUP_DELAY=180

      # Seconds to wait for YouTube to show "live" after restart
      - WATCHDOG_VERIFICATION_TIMEOUT=120

      # Check RTSP source health before recovery attempts
      # Prevents restart loops when camera/router is rebooting
      - WATCHDOG_RTSP_CHECK=true

      # Enable detailed logging of status checks
      - WATCHDOG_VERBOSE=true

      # How often to check stream status (seconds)
      - WATCHDOG_CHECK_INTERVAL=30

      # Initial delay before restart after detecting offline (seconds)
      # Uses exponential backoff: 10 -> 20 -> 40 -> 80 -> etc.
      - WATCHDOG_INITIAL_DELAY=10

      # Maximum backoff delay (seconds) - caps at 15 minutes by default
      - WATCHDOG_MAX_DELAY=900

      # How long stream must be stable before resetting backoff counter
      - WATCHDOG_STABILITY_THRESHOLD=30

      # =======================================================================
      # DISCORD NOTIFICATIONS (Optional)
      # =======================================================================
      # Get alerts when stream goes offline, recovers, RTSP down, or credential errors
      #
      # To get a webhook URL:
      # 1. Open Discord server settings -> Integrations -> Webhooks
      # 2. Click "New Webhook", name it "VantageCam", choose a channel
      # 3. Copy the webhook URL
      #
      # To get your User ID (for @mentions):
      # 1. Enable Developer Mode in Discord settings -> Advanced
      # 2. Right-click your username -> Copy User ID
      #
      - DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/xxxxx/xxxxx
      - DISCORD_USER_ID=123456789012345678

      # =======================================================================
      # YOUTUBE API SETTINGS (for auto-setting stream to PUBLIC)
      # =======================================================================
      # These are OPTIONAL - if not set, watchdog still works but won't
      # automatically change stream visibility after recovery
      #
      # Get these from Google Cloud Console:
      # 1. Create OAuth 2.0 credentials
      # 2. Enable YouTube Data API v3
      # 3. Generate refresh token using OAuth playground
      #
      - YOUTUBE_CLIENT_ID=your_client_id_here
      - YOUTUBE_CLIENT_SECRET=your_client_secret_here
      - YOUTUBE_REFRESH_TOKEN=your_refresh_token_here

    volumes:
      - /mnt/user/appdata/vantagecam:/config
    ports:
      - 8554:8554  # Video Output (RTSP) - only if ENABLE_LOCAL_STREAM=true
      - 9998:9998  # Audio API
    restart: unless-stopped

  # ============================================================
  # ALTERNATIVE: Software-only version (no Intel GPU)
  # ============================================================
  # vantagecam-software:
  #   image: ghcr.io/mcgeaverbeaver/vantagecamlive:software
  #   container_name: vantagecam
  #   # NO devices section needed
  #   environment:
  #     - PUID=99
  #     - PGID=100
  #     - RTSP_SOURCE=rtsp://user:pass@192.168.1.50:554/stream
  #     - ADMIN_USER=admin
  #     - ADMIN_PASS=change_me_please
  #     - HARDWARE_ACCEL=false
  #     - SOFTWARE_PRESET=faster
  #     - ENABLE_LOCAL_STREAM=false
  #     - WEATHER_LAT=40.7128
  #     - WEATHER_LON=-74.0060
  #     - WEATHER_LOCATION=My City
  #     - WEATHER_TIMEZONE=America/New_York
  #     - CAMERA_HEADING=E
  #     # YouTube
  #     - YOUTUBE_URL=rtmp://a.rtmp.youtube.com/live2
  #     - YOUTUBE_KEY=xxxx-xxxx-xxxx-xxxx
  #     # Self-healing
  #     - WATCHDOG_ENABLED=true
  #     - WATCHDOG_STATUS_URL=https://yourdomain.com/youtube_status.php
  #     - WATCHDOG_STARTUP_DELAY=180
  #     - WATCHDOG_VERIFICATION_TIMEOUT=120
  #     - WATCHDOG_RTSP_CHECK=true
  #     - WATCHDOG_VERBOSE=true
  #   volumes:
  #     - /mnt/user/appdata/vantagecam:/config
  #   ports:
  #     - 8554:8554
  #     - 9998:9998
  #   restart: unless-stopped